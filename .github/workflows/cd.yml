name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    branches: [ main ]
    types: [ completed ]

jobs:
  build-and-push:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      image_tag: ${{ steps.image_meta.outputs.image_tag }}
      image_name: ${{ steps.image_meta.outputs.image_name }}

    steps:
      - name: 소스 체크아웃
        uses: actions/checkout@v4

      - name: Java 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: gradlew 실행 권한 부여
        run: chmod +x gradlew

      - name: JAR 빌드 (테스트 제외)
        run: ./gradlew bootJar -x test

      - name: Docker Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Define image name and tag
        id: image_meta
        run: |
          IMAGE_TAG=$(date +'%Y%m%d-%H%M%S')
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/talent-of-time"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.image_meta.outputs.image_name }}:${{ steps.image_meta.outputs.image_tag }}
          cache-from: type=registry,ref=${{ steps.image_meta.outputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.image_meta.outputs.image_name }}:buildcache,mode=max

      - name: Clean up old images from Docker Hub
        run: |
          TAGS=$(curl -s \
            -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/talent-of-time/tags?page_size=100" \
            | jq -r '.results[].name' | grep -v 'buildcache' | sort -r)

          echo "$TAGS" | tail -n +3 | while read TAG; do
            echo "Deleting tag: $TAG"
            curl -s -X DELETE \
              -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" \
              "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/talent-of-time/tags/${TAG}/"
          done

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: 소스 체크아웃 (compose 파일 전송용)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.prod.yml
          sparse-checkout-cone-mode: false

      - name: SSH 키 설정
        run: |
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: 배포 디렉토리 생성
        run: |
          ssh -i deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "mkdir -p /home/${{ secrets.DEPLOY_USER }}/talent-of-time"

      - name: Copy compose file to remote
        run: |
          scp -i deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -P ${{ secrets.DEPLOY_PORT }} \
            ./docker-compose.prod.yml \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/home/${{ secrets.DEPLOY_USER }}/talent-of-time/

      - name: Run deployment on server
        run: |
          ssh -i deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            '
              set -e

              export DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
              export IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
              export DB_URL="${{ secrets.DB_URL }}"
              export DB_USERNAME="${{ secrets.DB_USERNAME }}"
              export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"

              echo "Cleaning up old tagged images (keeping last 2)..."
              docker images "${DOCKERHUB_USERNAME}/talent-of-time" --format "{{.Tag}}" | \
              sort -r | \
              tail -n +3 | \
              xargs -I {} docker rmi "${DOCKERHUB_USERNAME}/talent-of-time:{}" || true

              echo "Pruning dangling images..."
              docker image prune -f

              echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
              echo "Pulling new image: ${DOCKERHUB_USERNAME}/talent-of-time:${IMAGE_TAG}"
              docker pull "${DOCKERHUB_USERNAME}/talent-of-time:${IMAGE_TAG}"

              cd /home/${{ secrets.DEPLOY_USER }}/talent-of-time
              docker compose -f docker-compose.prod.yml down || true
              docker compose -f docker-compose.prod.yml up -d

              echo "Deployment finished successfully."
            '
